---
title: "Golang ã®æ–‡å­—åˆ—é€£çµã¯ã©ã¡ã‚‰ãŒé€Ÿã„ï¼Ÿ"
emoji: "ğŸ˜€"
type: "tech"
topics: [Go,ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯]
published: false
---
ï¼ˆè‡ªãƒ–ãƒ­ã‚°ã«ã¦[æ”¹è¨‚ç‰ˆ](https://text.baldanders.info/golang/join-strings-2/ "ã€æ”¹è¨‚ç‰ˆã€‘æ–‡å­—åˆ—é€£çµã¯ã©ã‚ŒãŒé€Ÿã„ï¼Ÿ â€” ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª Go | text.Baldanders.info")ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ï¼‰

Go è¨€èªã§æ–‡å­—åˆ—ã®é€£çµã‚’è¡Œã†éš›ã«ã©ã†ã‚„ã‚‹ã®ãŒä¸€ç•ªé€Ÿã„ã‹ï¼Œã¨ã„ã†è©±ã€‚

## æ–‡å­—åˆ—é€£çµã‚’è¡Œã†4ã¤ã®æ–¹æ³•

Go è¨€èªã§æ–‡å­—åˆ—ã®é€£çµã‚’è¡Œã†éš›ã«ã¯æ¦‚ã­ä»¥ä¸‹ã®4ã¤ã®æ–¹æ³•ãŒã‚ã‚‹ã€‚

1. â€œ`+`â€ æ¼”ç®—å­ã§é€£çµã™ã‚‹
1. [`strings`](http://golang.org/pkg/strings/)`.Join` ã§é€£çµã™ã‚‹
1. [`bytes`](http://golang.org/pkg/bytes/)`.Buffer` ã§è¿½è¨˜ã™ã‚‹
1. `[]byte` ã« append ã™ã‚‹

`string` å‹ã¯ã€Œä¸å¤‰ï¼ˆimmutableï¼‰ã€ãªã®ã§ï¼Œæœ€åˆã®2ã¤ãŒé«˜ã‚³ã‚¹ãƒˆã«ãªã‚‹ã ã‚ã†ã“ã¨ã¯ã™ãã«æƒ³åƒãŒã¤ãã€‚

- [Goã§ã¯æ–‡å­—åˆ—é€£çµã¯ã‚³ã‚¹ãƒˆã®é«˜ã„æ“ä½œ - Qiita](http://qiita.com/ruiu/items/2bb83b29baeae2433a79)
- [Goè¨€èªã§åŠ¹ç‡è‰¯ãæ–‡å­—åˆ—ã‚’é€£çµã™ã‚‹è©± #golang - memoãƒ¡ãƒ¢](http://atotto.hatenadiary.jp/entry/2013/04/26/202701)

ã§ã¯æ®‹ã‚Šã®2ã¤ã¯ã©ã†ãªã®ã‹ã¨ã„ã†ã¨

- [Goã®æ–‡å­—åˆ—çµåˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ - Qiita](http://qiita.com/ono_matope/items/d5e70d8a9ff2b54d5c37)

ã«ã‚ˆã‚‹ã¨æœ€å¾Œã®ãŒä¸€ç•ªé€Ÿã„ã‚‰ã—ã„ã€‚ã»ã‚“ã˜ã‚ƒã¾ãï¼Œç¢ºã‹ã‚ã¦ã¿ã‚‹ã‹ã€‚

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦è©•ä¾¡ã—ã¦ã¿ã‚‹ã€‚

```go:join.go
package main

import (
	"bufio"
	"bytes"
	"io"
)

//Read content (text data) from buffer
func ContentText(inStream io.Reader) ([]string, error) {
	scanner := bufio.NewScanner(inStream)
	list := make([]string, 0)
	for scanner.Scan() {
		list = append(list, scanner.Text())
	}
	if err := scanner.Err(); err != nil {
		return nil, err
	}
	return list, nil
}

//Write content (text data) to buffer
func WriteBuffer1(lines []string) []byte {
	//write to byte buffer
	content := make([]byte, 0)
	recode := "\r\n"
	for _, line := range lines {
		content = append(content, line...)
		content = append(content, recode...)
	}
	return content
}

//Write content (text data) to buffer
func WriteBuffer1Cap128(lines []string) []byte {
	//write to byte buffer
	content := make([]byte, 0, 128) //128 bytes capacity
	recode := "\r\n"
	for _, line := range lines {
		content = append(content, line...)
		content = append(content, recode...)
	}
	return content
}

//Write content (text data) to buffer
func WriteBuffer1Cap1K(lines []string) []byte {
	//write to byte buffer
	content := make([]byte, 0, 1024) //1K bytes capacity
	recode := "\r\n"
	for _, line := range lines {
		content = append(content, line...)
		content = append(content, recode...)
	}
	return content
}

//Write content (text data) to buffer (buffered I/O)
func WriteBuffer2(lines []string) []byte {
	//write to byte buffer
	content := bytes.NewBuffer(make([]byte, 0))
	recode := "\r\n"
	for _, line := range lines {
		content.WriteString(line)
		content.WriteString(recode)
	}
	return content.Bytes()
}

//Write content (text data) to buffer (buffered I/O)
func WriteBuffer2Cap128(lines []string) []byte {
	//write to byte buffer
	content := bytes.NewBuffer(make([]byte, 0, 128)) //128 bytes capacity
	recode := "\r\n"
	for _, line := range lines {
		content.WriteString(line)
		content.WriteString(recode)
	}
	return content.Bytes()
}

//Write content (text data) to buffer (buffered I/O)
func WriteBuffer2Cap1K(lines []string) []byte {
	//write to byte buffer
	content := bytes.NewBuffer(make([]byte, 0, 1024)) //1K bytes capacity
	recode := "\r\n"
	for _, line := range lines {
		content.WriteString(line)
		content.WriteString(recode)
	}
	return content.Bytes()
}
```

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```go:join_test.go
package main

import (
	"os"
	"testing"
)

var list []string

func readFile() {
	file, err := os.Open("CollisionsForHashFunctions.txt") //maybe file path
	if err != nil {
		panic(err)
	}
	defer file.Close()
	list, err = ContentText(file)
	if err != nil {
		panic(err)
	}
}

func BenchmarkWriteBuffer1(b *testing.B) {
	readFile()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		content := WriteBuffer1(list)
		_ = content
	}
}

func BenchmarkWriteBuffer1Cap128(b *testing.B) {
	readFile()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		content := WriteBuffer1Cap128(list)
		_ = content
	}
}

func BenchmarkWriteBuffer1Cap1K(b *testing.B) {
	readFile()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		content := WriteBuffer1Cap1K(list)
		_ = content
	}
}

func BenchmarkWriteBuffer2(b *testing.B) {
	readFile()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		content := WriteBuffer2(list)
		_ = content
	}
}

func BenchmarkWriteBuffer2Cap128(b *testing.B) {
	readFile()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		content := WriteBuffer2Cap128(list)
		_ = content
	}
}

func BenchmarkWriteBuffer2Cap1K(b *testing.B) {
	readFile()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		content := WriteBuffer2Cap1K(list)
		_ = content
	}
}
```

å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã ãŒï¼Œå°ã•ã„ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ãƒ†ã‚¹ãƒˆã«ãªã‚‰ãªã„æ°—ãŒã—ãŸã®ã§ï¼Œå¤§æ˜”ã«æ›¸ã„ãŸãƒ†ã‚­ã‚¹ãƒˆ [`CollisionsForHashFunctions.txt`](http://www.baldanders.info/spiegel/archive/CollisionsForHashFunctions.txt) ã‚’ä½¿ã†ã“ã¨ã«ã—ãŸã€‚ã‚µã‚¤ã‚ºã¯70è¡Œï¼Œ8KB ã»ã©ã€‚

## ãƒ†ã‚¹ãƒˆçµæœ

çµæœã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚

```shell
C:>go test -bench WriteBuffer -benchmen
testing: warning: no tests to run
PASS
BenchmarkWriteBuffer1-4           100000     12220 ns/op  28864 B/op  11 allocs/op
BenchmarkWriteBuffer1Cap128-4     100000     11620 ns/op  28800 B/op  10 allocs/op
BenchmarkWriteBuffer1Cap1K-4      200000     11605 ns/op  27904 B/op   7 allocs/op
BenchmarkWriteBuffer2-4           100000     14200 ns/op  25568 B/op   9 allocs/op
BenchmarkWriteBuffer2Cap128-4     100000     15790 ns/op  26800 B/op   8 allocs/op
BenchmarkWriteBuffer2Cap1K-4      200000     10305 ns/op  17520 B/op   5 allocs/op
ok      join    13.260s
```

ã‚ã‚Šã‚ƒã‚Šã‚ƒã€‚ [`bytes`](http://golang.org/pkg/bytes/)`.Buffer` ã‚’ä½¿ã£ãŸã»ã†ãŒé€Ÿã„ã¿ãŸã„ï¼ˆcapacity ã‚’å¤§ããã¨ã‚Œã°ï¼‰ã€‚

ãã‚Œãªã‚‰ï¼Œãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ä¸€æ°—ã«å°ã•ãã—ã¦9è¡Œï¼Œ1KB ã«ã—ã¦ã‚„ã£ã¦ã¿ã‚‹ã€‚

```shell
C:>go test -bench WriteBuffer -benchmen
testing: warning: no tests to run
PASS
BenchmarkWriteBuffer1-4          3000000       443 ns/op    448 B/op   3 allocs/op
BenchmarkWriteBuffer1Cap128-4    5000000       345 ns/op    384 B/op   2 allocs/op
BenchmarkWriteBuffer1Cap1K-4     3000000       561 ns/op   1024 B/op   1 allocs/op
BenchmarkWriteBuffer2-4          1000000      1079 ns/op    544 B/op   4 allocs/op
BenchmarkWriteBuffer2Cap128-4    2000000       727 ns/op    560 B/op   3 allocs/op
BenchmarkWriteBuffer2Cap1K-4     2000000       663 ns/op   1136 B/op   2 allocs/op
ok      join    11.987s
```

ä»Šåº¦ã¯ `[]bytes` ã®æ–¹ãŒé€Ÿããªã£ãŸã€‚

ã¾ãã§ã‚‚äºˆæƒ³é€šã‚Šã‹ãªã€‚ãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚Œã°ãƒãƒƒãƒ•ã‚¡æ“ä½œã®ã»ã†ãŒæœ‰åˆ©ã«ãªã‚‹ã®ã¯åˆ†ã‹ã‚Šã‚„ã™ã„ã£ã¡ã‚ƒã‚åˆ†ã‹ã‚Šã‚„ã™ã„ã€‚æ³¨ç›®ã™ã¹ãã¯ `BenchmarkWriteBuffer1Cap128` ã¨ `BenchmarkWriteBuffer1Cap1K` ã§ï¼Œ capacity ã‚’ 1KB å–ã£ãŸã»ã†ãŒè‹¥å¹²é…ããªã£ã¦ã„ã‚‹ã€‚ã“ã®è¾ºã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ã©ã†ã™ã‚‹ã‹ï¼Œã¨ã„ã†ã¨ã“ã‚ãªã®ã ã‚ã†ã€‚

