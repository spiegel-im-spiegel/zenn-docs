---
title: "ent でテーブル設計する"
---

## スキーマ定義の確認

スキーマ定義を確認するには以下のコマンドを叩けばよい。

```
$ go run -mod=mod entgo.io/ent/cmd/ent describe ./ent/schema
BinaryFile:
    +------------+-----------+--------+----------+----------+---------+---------------+-----------+-----------------------------+------------+
    |   Field    |   Type    | Unique | Optional | Nillable | Default | UpdateDefault | Immutable |          StructTag          | Validators |
    +------------+-----------+--------+----------+----------+---------+---------------+-----------+-----------------------------+------------+
    | id         | int       | false  | false    | false    | false   | false         | false     | json:"id,omitempty"         |          0 |
    | filename   | string    | true   | false    | false    | false   | false         | false     | json:"filename,omitempty"   |          1 |
    | body       | []byte    | false  | true     | true     | false   | false         | false     | json:"body,omitempty"       |          0 |
    | created_at | time.Time | false  | false    | false    | true    | false         | false     | json:"created_at,omitempty" |          0 |
    | updated_at | time.Time | false  | false    | false    | true    | false         | false     | json:"updated_at,omitempty" |          0 |
    +------------+-----------+--------+----------+----------+---------+---------------+-----------+-----------------------------+------------+
    +-------+------+---------+---------+----------+--------+----------+
    | Edge  | Type | Inverse | BackRef | Relation | Unique | Optional |
    +-------+------+---------+---------+----------+--------+----------+
    | owner | User | true    | files   | M2O      | true   | true     |
    +-------+------+---------+---------+----------+--------+----------+

User:
    +------------+-----------+--------+----------+----------+---------+---------------+-----------+-----------------------------+------------+
    |   Field    |   Type    | Unique | Optional | Nillable | Default | UpdateDefault | Immutable |          StructTag          | Validators |
    +------------+-----------+--------+----------+----------+---------+---------------+-----------+-----------------------------+------------+
    | id         | int       | false  | false    | false    | false   | false         | false     | json:"id,omitempty"         |          0 |
    | username   | string    | true   | false    | false    | false   | false         | false     | json:"username,omitempty"   |          2 |
    | created_at | time.Time | false  | false    | false    | true    | false         | false     | json:"created_at,omitempty" |          0 |
    | updated_at | time.Time | false  | false    | false    | true    | false         | false     | json:"updated_at,omitempty" |          0 |
    +------------+-----------+--------+----------+----------+---------+---------------+-----------+-----------------------------+------------+
    +-------+------------+---------+---------+----------+--------+----------+
    | Edge  |    Type    | Inverse | BackRef | Relation | Unique | Optional |
    +-------+------------+---------+---------+----------+--------+----------+
    | files | BinaryFile | false   |         | O2M      | false  | true     |
    +-------+------------+---------+---------+----------+--------+----------+
```

これで必要な属性が付与されているか確認することができるだろう。

## スキーマ定義から ER 図を出力する

[ent] の中の人が個人アカウントで公開されているツールに [a8m/enter] というツールがある

https://github.com/a8m/enter

これを使って

```
$ go run github.com/a8m/enter@latest ./ent/schema
```

などとやると er.html ファイルを出力する。中身は [mermaid.js] の記法で書かれた ER 図で，ブラウザで開くと以下のように表示される。

![](/images/books/a-study-in-postgresql/mermaid.png)

（JavaScript で表示を若干いじってるようで，そのまま [mermaid][mermaid.js] 記法のコードを Zenn に持ち込めないのが残念）

[Mermaid][mermaid.js] 記法で書けるなら [PlantUML でも書ける](https://text.baldanders.info/remark/2019/07/plantuml-4-entity-relationship-diagrams/ "真面目に PlantUML 4 : 実体関連図 | text.Baldanders.info")よな，多分。今度試してみよう。

## スキーマ定義から DDL を出力する

[ent] ではスキーマ定義から DDL を出力することができる。

```go:sample2.go
func Run() exitcode.ExitCode {
    // get ent context
    entCtx, err := dbconn.NewEnt()
    if err != nil {
        fmt.Fprintln(os.Stderr, err)
        return exitcode.Abnormal
    }
    defer entCtx.Close()

    // output DDL
    if err := entCtx.GetClient().Schema.WriteTo(context.TODO(), os.Stdout); err != nil {
        entCtx.GetLogger().Error().Interface("error", errs.Wrap(err)).Send()
        return exitcode.Abnormal
    }

    return exitcode.Normal
}
```

これを実行すると

```
$ go run sample2.go
BEGIN;
CREATE TABLE IF NOT EXISTS "binary_files"("id" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, "filename" varchar UNIQUE NOT NULL, "body" bytea NULL, "created_at" timestamp with time zone NOT NULL, "updated_at" timestamp with time zone NOT NULL, "user_files" bigint NULL, PRIMARY KEY("id"));
CREATE TABLE IF NOT EXISTS "users"("id" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, "username" varchar UNIQUE NOT NULL, "created_at" timestamp with time zone NOT NULL, "updated_at" timestamp with time zone NOT NULL, PRIMARY KEY("id"));
ALTER TABLE "binary_files" ADD CONSTRAINT "binary_files_users_files" FOREIGN KEY("user_files") REFERENCES "users"("id") ON DELETE SET NULL;
COMMIT;
```

と出力される。分かりにくいな（笑） 適当に整形するか。

```sql
BEGIN
;
CREATE TABLE IF NOT EXISTS "binary_files"(
   "id" bigint GENERATED BY
     DEFAULT AS IDENTITY NOT NULL
    ,"filename" varchar UNIQUE NOT NULL
    ,"body" bytea NULL
    ,"created_at" timestamp with time zone NOT NULL
    ,"updated_at" timestamp with time zone NOT NULL
    ,"user_files" bigint NULL
    ,PRIMARY KEY("id")
)
;
CREATE TABLE IF NOT EXISTS "users"(
   "id" bigint GENERATED BY
     DEFAULT AS IDENTITY NOT NULL
    ,"username" varchar UNIQUE NOT NULL
    ,"created_at" timestamp with time zone NOT NULL
    ,"updated_at" timestamp with time zone NOT NULL
    ,PRIMARY KEY("id")
)
;
ALTER TABLE "binary_files" ADD CONSTRAINT "binary_files_users_files" FOREIGN KEY(
  "user_files"
) REFERENCES "users"(
  "id"
)
ON  DELETE
SET
  NULL
;
COMMIT
;
```

1. やっぱテーブル名って複数形なんだな。これが普通ってことか
2. `username` は MaxLen(63) でサイズ制限を付けたのだが [PostgreSQL] 側で varchar でサイズ制限するわけじゃないのか
3. foreign key にしている `user_files` は NOT NULL にできないっぽい。元のレコードが削除されたときに NULL にセットできないと困るからかな？

foreign key を使いたくない場合は WithForeignKeys() 関数で

```go
// output DDL
if err := entCtx.GetClient().Schema.WriteTo(context.TODO(), os.Stdout, , migrate.WithForeignKeys(false)); err != nil {
    entCtx.GetLogger().Error().Interface("error", errs.Wrap(err)).Send()
    return exitcode.Abnormal
}
```

とすればいいらしい。後述の Create() メソッドでも同様。

## テーブルの作成

では，いよいよテーブルを作成しよう。さきほどの sample2.go を少しいじって

```go:sample3.go
// create tables
if err := entCtx.GetClient().Schema.Create(context.TODO()); err != nil {
	entCtx.GetLogger().Error().Interface("error", errs.Wrap(err)).Send()
	return exitcode.Abnormal
}
```

とする。実行結果は以下の通り。

```
$ go run sample3.go
0:00AM INF Dialing PostgreSQL server host=hostname module=pgx
0:00AM INF Exec args=[] commandTag=QkVHSU4= module=pgx pid=5627 sql=begin
0:00AM DBG driver.Tx(c1c333dd-da13-4dc9-965b-7a75bda48834): started
0:00AM DBG Tx(c1c333dd-da13-4dc9-965b-7a75bda48834).Query: query=SHOW server_version_num args=[]
0:00AM INF Query args=[] module=pgx pid=5627 rowCount=1 sql="SHOW server_version_num"
0:00AM DBG Tx(c1c333dd-da13-4dc9-965b-7a75bda48834).Query: query=SELECT COUNT(*) FROM "information_schema"."tables" WHERE "table_schema" = CURRENT_SCHEMA() AND "table_name" = $1 args=[binary_files]
0:00AM INF Query args=["binary_files"] module=pgx pid=5627 rowCount=1 sql="SELECT COUNT(*) FROM \"information_schema\".\"tables\" WHERE \"table_schema\" = CURRENT_SCHEMA() AND \"table_name\" = $1"
0:00AM DBG Tx(c1c333dd-da13-4dc9-965b-7a75bda48834).Exec: query=CREATE TABLE IF NOT EXISTS "binary_files"("id" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, "filename" varchar UNIQUE NOT NULL, "body" bytea NULL, "created_at" timestamp with time zone NOT NULL, "updated_at" timestamp with time zone NOT NULL, "user_files" bigint NULL, PRIMARY KEY("id")) args=[]
0:00AM INF Exec args=[] commandTag=Q1JFQVRFIFRBQkxF module=pgx pid=5627 sql="CREATE TABLE IF NOT EXISTS \"binary_files\"(\"id\" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, \"filename\" varchar UNIQUE NOT NULL, \"body\" bytea NULL, \"created_at\" timestamp with time zone NOT NULL, \"updated_at\" timestamp with time zone NOT NULL, \"user_files\" bigint NULL, PRIMARY KEY(\"id\"))"
0:00AM DBG Tx(c1c333dd-da13-4dc9-965b-7a75bda48834).Query: query=SELECT COUNT(*) FROM "information_schema"."tables" WHERE "table_schema" = CURRENT_SCHEMA() AND "table_name" = $1 args=[users]
0:00AM INF Query args=["users"] module=pgx pid=5627 rowCount=1 sql="SELECT COUNT(*) FROM \"information_schema\".\"tables\" WHERE \"table_schema\" = CURRENT_SCHEMA() AND \"table_name\" = $1"
0:00AM DBG Tx(c1c333dd-da13-4dc9-965b-7a75bda48834).Exec: query=CREATE TABLE IF NOT EXISTS "users"("id" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, "username" varchar UNIQUE NOT NULL, "created_at" timestamp with time zone NOT NULL, "updated_at" timestamp with time zone NOT NULL, PRIMARY KEY("id")) args=[]
0:00AM INF Exec args=[] commandTag=Q1JFQVRFIFRBQkxF module=pgx pid=5627 sql="CREATE TABLE IF NOT EXISTS \"users\"(\"id\" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, \"username\" varchar UNIQUE NOT NULL, \"created_at\" timestamp with time zone NOT NULL, \"updated_at\" timestamp with time zone NOT NULL, PRIMARY KEY(\"id\"))"
0:00AM DBG Tx(c1c333dd-da13-4dc9-965b-7a75bda48834).Query: query=SELECT COUNT(*) FROM "information_schema"."table_constraints" WHERE "table_schema" = CURRENT_SCHEMA() AND "constraint_type" = $1 AND "constraint_name" = $2 args=[FOREIGN KEY binary_files_users_files]
0:00AM INF Query args=["FOREIGN KEY","binary_files_users_files"] module=pgx pid=5627 rowCount=1 sql="SELECT COUNT(*) FROM \"information_schema\".\"table_constraints\" WHERE \"table_schema\" = CURRENT_SCHEMA() AND \"constraint_type\" = $1 AND \"constraint_name\" = $2"
0:00AM DBG Tx(c1c333dd-da13-4dc9-965b-7a75bda48834).Exec: query=ALTER TABLE "binary_files" ADD CONSTRAINT "binary_files_users_files" FOREIGN KEY("user_files") REFERENCES "users"("id") ON DELETE SET NULL args=[]
0:00AM INF Exec args=[] commandTag=QUxURVIgVEFCTEU= module=pgx pid=5627 sql="ALTER TABLE \"binary_files\" ADD CONSTRAINT \"binary_files_users_files\" FOREIGN KEY(\"user_files\") REFERENCES \"users\"(\"id\") ON DELETE SET NULL"
0:00AM DBG Tx(c1c333dd-da13-4dc9-965b-7a75bda48834): committed
0:00AM INF Exec args=[] commandTag=Q09NTUlU module=pgx pid=5627 sql=commit
0:00AM INF closed connection module=pgx pid=5627
```

うおっ，デバッグモードにするんじゃなかった。まぁ，いいや。ちゃんと作成されているからよしとしよう。

## ent では Primary Key を変更できない（今のところ）

Primary key である `id` カラムの型については，一応 entc generate のオプションである程度変更できるし Field() 定義で上書き変更することも可能らしい（uuid に変更する場合など）。でも primary key を `id` カラム以外に変更することは出来ないし，もっと言うと primary key を複数定義することも出来ないようだ。この辺は以下の issue で議論されているように見えるが，まだ実装には至ってないようだ。

https://github.com/ent/ent/issues/400
https://github.com/ent/ent/issues/1949

私はこの時点で [ent] の採用を泣く泣く見送った。

おそらく，実験的実装以外で [ent] を採用するのであれば，要件定義の段階からコードを書いて議論していかないと無理だろう。特にレガシー・システムから入れ替えたい場合などは，かなり斬新な設計変更が求められるんじゃないかな。紙や Excel 方眼紙でスキーマ設計する時代は終わったのである（笑）

まぁ，でも，いまどきはデータ同士の関係が合理的にグラフ化出来ないと先に進めないので， [ent] のような「コードで関係を設計する」手法は今後増えていくのかもしれない。

[ent]: https://entgo.io/
[PostgreSQL]: https://www.postgresql.org/ "PostgreSQL: The world's most advanced open source database"
[Go]: https://go.dev/
[github.com/ent/ent]: https://github.com/ent/ent "ent/ent: An entity framework for Go"
[database/sql]: https://pkg.go.dev/database/sql "sql package - database/sql - pkg.go.dev"
[github.com/jackc/pgx]: https://github.com/jackc/pgx "jackc/pgx: PostgreSQL driver and toolkit for Go"
[github.com/rs/zerolog]: https://github.com/rs/zerolog "rs/zerolog: Zero Allocation JSON Logger"
[a8m/enter]: https://github.com/a8m/enter "a8m/enter: A CLI for generating ER diagrams for Ent schema"
[mermaid.js]: https://mermaid-js.github.io/mermaid/ "mermaid - Markdownish syntax for generating flowcharts, sequence diagrams, class diagrams, gantt charts and git graphs."
