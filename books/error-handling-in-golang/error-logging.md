---
title: "ã¼ããŒã‹ã‚“ãŒãˆãŸã•ã„ãã‚‡ã†ã®ãˆã‚‰ãƒ¼ã‚ã"
---

## ç§ã®æ¬²ã—ã„ã‚¨ãƒ©ãƒ¼ã¨è²´æ–¹ã®æ¬²ã—ã„ã‚¨ãƒ©ãƒ¼ã¯é•ã†

ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§æœ€ã‚‚è€ƒæ…®ã™ã¹ãã“ã¨ã¯

ğŸ’¡ **åˆ©ç”¨è€…ãŒæ¬²ã—ã„ã‚¨ãƒ©ãƒ¼æƒ…å ±ã¨æä¾›è€…ãŒæ¬²ã—ã„ã‚¨ãƒ©ãƒ¼æƒ…å ±ã¯ç•°ãªã‚‹** ğŸ’¡

ã¨ã„ã†ç‚¹ã ã‚ã†ã€‚

ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã«åˆ©ç”¨è€…ãŒæœ€ã‚‚æ¬²ã—ã„æƒ…å ±ã¯ã€Œã©ã†ã™ã‚Œã°ã„ã„ã®ã‹ï¼Ÿã€ã§ã‚ã‚‹ã€‚ãã®ãŸã‚ã®ãƒ’ãƒ³ãƒˆã¨ã—ã¦ã€Œä½•æ•…ã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã£ãŸã®ã‹ï¼Ÿã€ã‚‚æ¬²ã—ã„ã‚ã‘ã ã€‚

ãŸã¨ãˆã°ï¼Œã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ»ãƒ„ãƒ¼ãƒ«ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æä¾›ã™ã‚‹ [spf13/cobra] ã¯åˆ©ç”¨è€…ãŒã‚³ãƒãƒ³ãƒ‰å…¥åŠ›ã‚’é–“é•ãˆãŸéš›ã«æ­£ã—ã„ã‚³ãƒãƒ³ãƒ‰ã‚’æ¨æ¸¬ã—ã¦æ•™ãˆã¦ãã‚Œã‚‹ã€‚[ç§ãŒå…¬é–‹ã—ã¦ã„ã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ»ãƒ„ãƒ¼ãƒ«](https://github.com/goark/gpgpdump "goark/gpgpdump: OpenPGP packet visualizer")ã ã¨ã“ã‚“ãªæ„Ÿã˜ã€‚

```
$ gpgpdump http
Error: unknown command "http" for "gpgpdump"

Did you mean this?
    hkp

Run 'gpgpdump --help' for usage.
```

ã“ã‚Œã§æœ¬å½“ã« `gpgpdump hkp` ã¨æ‰“ã¡é–“é•ãˆãŸã®ãªã‚‰æ‰“ã¡ç›´ã›ã°ã„ã„ã—ï¼Œå…¨ç„¶é•ã†ã¨ã„ã†ã®ãªã‚‰ `gpgpdump --help` ã§ä½¿ã„æ–¹ã‚’è¡¨ç¤ºã—ã¦ã¿ã‚Œã°ã„ã„ï¼Œã¨åˆ†ã‹ã‚‹ã€‚

ä¸€æ–¹ï¼Œæä¾›è€…å´ã«ã¨ã£ã¦ï¼ˆåˆ©ç”¨è€…ã«ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’æä¾›ã™ã‚‹ã«ã›ã‚ˆï¼‰æœ€ã‚‚æ¬²ã—ã„æƒ…å ±ã¯ã€Œã©ã†ã‚„ã£ã¦èµ·ããŸã‹ï¼Ÿã€ã§ã‚ã‚‹ã€‚ã“ã‚Œã‚’çŸ¥ã‚‹ãŸã‚ã«ã¯ï¼Œä½•æ•…ï¼ˆï¼åŸå› ï¼‰ã‚‚å«ã‚ã¦ï¼Œã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ã€Œæ–‡è„ˆã€ã‚’ã§ãã‚‹ã ã‘ã‹ãé›†ã‚ã‚‹ã“ã¨ãŒé‡è¦ã§ã‚ã‚‹ã€‚

ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±ã‚’æ¬²ã—ãŒã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒå¤šã„ã®ã¯ï¼Œã“ã®æƒ…å ±ãŒã€Œæ–‡è„ˆã€ã®ä¸€éƒ¨ã¨ãªã‚Šã†ã‚‹ã‹ã‚‰ã ã€‚ã§ã‚‚ï¼Œã“ã‚Œã¯å€‹äººçš„ãªè¦‹è§£ã ãŒï¼Œã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±ã¯9å‰²ä»¥ä¸ŠãŒãƒã‚¤ã‚ºã§ã‚ã‚‹ï¼ˆå®Ÿè¡Œæ™‚ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ æ§‹é€ è§£æãŒã—ãŸã„ãªã‚‰åˆ¥ã ãŒï¼‰ã€‚å–©ãˆã‚‹ãªã‚‰è—æŸã®ä¸­ã‹ã‚‰é‡‘ã®é‡ã‚’æ¢ã™ã‚ˆã†ãªã‚‚ã®ã ã€‚

ã˜ã‚ƒã‚ï¼Œã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯ã©ã†ã„ã†æˆ¦è¡“ã‚’ã¨ã‚‹ã®ãŒã„ã„ã®ã ã‚ã†ã€‚

...ã¨ã„ã†ã‚ã‘ã§ï¼Œãã‚ãã‚ã€Œã¼ããŒã‹ã‚“ãŒãˆãŸã•ã„ãã‚‡ã†ã®ãˆã‚‰ãƒ¼ã‚ãã€ã®å‡ºç•ªã ï¼ˆç¬‘ï¼‰

## [goark/errs][errs]

[goark/errs][errs] ã¯è‡ªä½œã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚¯ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ï¼Œä»–ã§å…¬é–‹ã—ã¦ã„ã‚‹è‡ªä½œã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ»ãƒ„ãƒ¼ãƒ«ã®ä¸­ã§ä¸»ã«ä½¿ã£ã¦ã„ã‚‹ãŒï¼Œä¸€å¿œã¯æ±ç”¨ã§ä½¿ãˆã‚‹ã‚ˆã†æ§‹æˆã—ã¦ã„ã‚‹ã€‚ä¸»ãªç‰¹å¾´ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

- [errors] æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ç½®ãæ›ãˆå¯èƒ½ï¼ˆ[errs].Is(), [errs].As() ç­‰ã®é–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ï¼‰
- [errs].WithContext() é–¢æ•°ã‚’ä½¿ã£ã¦ä»»æ„ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’ä»˜åŠ ã§ãã‚‹ã€‚ä»˜åŠ ã—ãŸæƒ…å ±ã¯ map[string]interface{} å‹ã®é€£æƒ³é…åˆ—ã§ä¿æŒã•ã‚Œã‚‹ 
    - æ—¢å®šã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸé–¢æ•°åã‚’æ ¼ç´ã—ã¦ã„ã‚‹
- `%+v` æ›¸å¼ã‚’ä½¿ã£ã¦ã‚¨ãƒ©ãƒ¼æƒ…å ±ã®è©³ç´°ã‚’ JSON å½¢å¼ã§å‡ºåŠ›ã§ãã‚‹ã€‚ã¾ãŸ MarshalJSON() ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‚™ãˆã¦ã„ã‚‹ã®ã§ [encoding/json][json] æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ JSON å½¢å¼ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ãã‚‹ï¼ˆãƒ‡ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯ãªã„ï¼‰

ç°¡å˜ãªä½¿ã„æ–¹ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚ç…§ã®ã“ã¨ã€‚

https://text.baldanders.info/release/errs-package-for-golang/

ãŸã¨ãˆã°ï¼Œã“ã‚“ãªæ„Ÿã˜ã«æ›¸ã‘ã‚‹ã€‚

```go:sample5.go
package main

import (
    "fmt"
    "os"

    "github.com/goark/errs"
)

func checkFileOpen(path string) error {
    file, err := os.Open(path)
    if err != nil {
        return errs.Wrap(
            err,
            errs.WithContext("path", path),
        )
    }
    defer file.Close()
    return nil
}

func main() {
    if err := checkFileOpen("not-exist.txt"); err != nil {
        fmt.Printf("%+v\n", err)
        return
    }
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨

```
$ go run sample5.go
{"Type":"*errs.Error","Err":{"Type":"*os.PathError","Msg":"open not-exist.txt: no such file or directory","Cause":{"Type":"syscall.Errno","Msg":"no such file or directory"}},"Context":{"function":"main.checkFileOpen","path":"not-exist.txt"}}
```

ã¦ãªæ„Ÿã˜ã«ã‚¨ãƒ©ãƒ¼ãŒ JSON å½¢å¼ã§è¡¨ç¤ºã•ã‚Œã‚‹ã€‚ã“ã®ã¾ã¾ã ã¨è¦‹ã«ãã„ã®ã§ [jq] ã‚³ãƒãƒ³ãƒ‰ç­‰ã‚’ä½¿ã£ã¦

```
$ go run sample5.go | jq .
{
  "Type": "*errs.Error",
  "Err": {
    "Type": "*os.PathError",
    "Msg": "open not-exist.txt: no such file or directory",
    "Cause": {
      "Type": "syscall.Errno",
      "Msg": "no such file or directory"
    }
  },
  "Context": {
    "function": "main.checkFileOpen",
    "path": "not-exist.txt"
  }
}
```

ãªã©ã¨ã™ã‚Œã°åˆ†ã‹ã‚Šã‚„ã™ã„ã‹ãªã€‚è‡ªä½œã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ»ãƒ„ãƒ¼ãƒ«ã§ã¯ `--debug` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã¨ JSON å½¢å¼ã®ã‚¨ãƒ©ãƒ¼ã‚’åãã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚

## [rs/zerolog][zerolog] ã‚’ä½¿ã£ã¦æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹

[rs/zerolog][zerolog] ãƒ­ã‚®ãƒ³ã‚°ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒã‚ˆãï¼Œã—ã‹ã‚‚ JSON å½¢å¼ã§ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹å„ªã‚Œã‚‚ã®ã§ã‚ã‚‹ã€‚ã“ã‚Œã‚’æ‹™ä½œã® [goark/errs][errs] ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã€‚

ã“ã‚“ãªæ„Ÿã˜ã§ã©ã†ã ã‚ã†ã€‚

```go:sample6.go
func main() {
    logger := zerolog.New(os.Stdout).Level(zerolog.DebugLevel).With().
        Timestamp().
        Str("role", "logger-sample").
        Logger()

    if err := checkFileOpen("not-exist.txt"); err != nil {
        logger.Error().Interface("error", err).Send()
        return
    }
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨

```
$ go run sample6.go | jq -s .
[
  {
    "level": "error",
    "role": "logger-sample",
    "error": {
      "Type": "*errs.Error",
      "Err": {
        "Type": "*os.PathError",
        "Msg": "open not-exist.txt: no such file or directory",
        "Cause": {
          "Type": "syscall.Errno",
          "Msg": "no such file or directory"
        }
      },
      "Context": {
        "function": "main.checkFileOpen",
        "path": "not-exist.txt"
      }
    },
    "time": "2020-12-10T19:16:29+09:00"
  }
]
```

ã¨ã„ã†æ„Ÿã˜ã«ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ JSON å½¢å¼ã§åŸ‹ã‚è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹[^elog1]ã€‚

[^elog1]: å®Ÿéš›ã«ã¯ [zerolog] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ [errs] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®çµåˆã§ã¯å°‘ã—è©¦è¡ŒéŒ¯èª¤ã—ã¦ã„ã‚‹ã€‚ãã®è¾ºã®æ§˜å­ã¯ã€Œ[æ§‹é€ åŒ–ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹](https://text.baldanders.info/golang/logging-error/)ã€ã‚’ã”è¦§ã‚ã‚Œã€‚

ã¡ãªã¿ã«ï¼Œä¸Šã®ã‚ˆã†ã« [jq] ã« `-s` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã¨è¤‡æ•°ã® JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã«çµ„ã¿ãªãŠã—ã¦å‡ºåŠ›ã—ã¦ãã‚Œã‚‹ã€‚ [encoding/json][json] æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†ãªã‚‰ [json].NewDecoder() é–¢æ•°ã§ãƒ‡ã‚³ãƒ¼ãƒ€ã‚’ä½œã‚Œã°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãã‚Œã‚‹ã®ã§ï¼Œ [for æ–‡][for]ã§ EOF ã¾ã§å›ã›ã°ã‚ˆã„ã€‚

[rs/zerolog][zerolog] ã‚’ä½¿ãˆã°ãƒ­ã‚°ã‚’å†åˆ©ç”¨ã—ã‚„ã™ããªã‚‹ã®ã§ï¼Œæ˜¯éã¨ã‚‚æ´»ç”¨ã—ã¦ã„ããŸã„ã¨ã“ã‚ã§ã‚ã‚‹ã€‚

## [zap] ã‚’ä½¿ã£ã¦æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã€2023-05-20 è¿½è¨˜ã€‘

[Zap][zap] ã¯ gRPC é–¢é€£ã‚µãƒ¼ãƒ“ã‚¹ã‚„åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ãªã©ã§äººæ°—ã®é«˜ã„ logger ã§ï¼ŒæŸ”è»Ÿãªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒã§ãï¼Œã‹ã¤é«˜é€Ÿã§ JSON å½¢å¼ã®æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å‡ºåŠ›ã§ãã‚‹ã€‚ã“ã® logger ã«æ‹™ä½œã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é£Ÿã‚ã›ã¦ã¿ã‚‹ã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```go:sample7.go
package main

import (
    "os"

    "github.com/goark/errs"
    "go.uber.org/zap"
)

func checkFileOpen(path string) error {
    file, err := os.Open(path)
    if err != nil {
        return errs.New(
            "file open error",
            errs.WithCause(err),
            errs.WithContext("path", path),
        )
    }
    defer file.Close()

    return nil
}

func main() {
    logger := zap.NewExample()
    defer logger.Sync()

    path := "not-exist.txt"
    if err := checkFileOpen("not-exist.txt"); err != nil {
        logger.Error("error in checkFileOpen function", zap.Error(err), zap.String("file", path))
    }
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨

```
$ go run sample7.go | jq .
{
  "level": "error",
  "msg": "error in checkFileOpen function",
  "error": "file open error: open not-exist.txt: no such file or directory",
  "errorVerbose": "{\"Type\":\"*errs.Error\",\"Err\":{\"Type\":\"*errors.errorString\",\"Msg\":\"file open error\"},\"Context\":{\"function\":\"main.checkFileOpen\",\"path\":\"not-exist.txt\"},\"Cause\":{\"Type\":\"*fs.PathError\",\"Msg\":\"open not-exist.txt: no such file or directory\",\"Cause\":{\"Type\":\"syscall.Errno\",\"Msg\":\"no such file or directory\"}}}",
  "file": "not-exist.txt"
}
```

ã¨ãªã‚‹ã€‚
`"error"` é …ç›®ã‚‚ `"errorVerbose"` é …ç›®ã‚‚æ–‡å­—åˆ—ã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã¦ã—ã¾ã†ãŸã‚æ§‹é€ åŒ–ã•ã‚Œã¦ã„ã‚‹ã¨ã¯è¨€ãˆãªã„ã€‚

[Zap][zap] ã«ã¯ [zap].Object() é–¢æ•°ãŒã‚ã£ã¦ï¼Œã“ã‚Œã‚’ä½¿ãˆã°å†…éƒ¨æ§‹é€ ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã ãŒï¼Œã“ã®é–¢æ•°ã‚’ä½¿ã†ãŸã‚ã«ã¯å¯¾è±¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ [zapcore].ObjectMarshaler å‹ã® interface ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹ã€‚

```go
type ObjectMarshaler interface {
    MarshalLogObject(ObjectEncoder) error
}
```

ã“ã®è¦ä»¶ã‚’æº€ãŸã™ãŸã‚ã« [goark/errs/zapobject][zapobject] ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œã£ãŸã€‚ã“ã‚“ãªæ„Ÿã˜ã« error ã‚’ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã—ã¦ä½¿ã†ã€‚

```go:sample8.go
package main

import (
    "os"

    "github.com/goark/errs"
    "github.com/goark/errs/zapobject"
    "go.uber.org/zap"
)

func checkFileOpen(path string) error {
    ...
}

func main() {
    logger := zap.NewExample()
    defer logger.Sync()

    path := "not-exist.txt"
    if err := checkFileOpen("not-exist.txt"); err != nil {
        logger.Error("error in checkFileOpen function", zap.Object("error", zapobject.New(err)), zap.String("file", path))
    }
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨

```
$ go run sample8.go | jq .
{
  "level": "error",
  "msg": "error in checkFileOpen function",
  "error": {
    "type": "*errs.Error",
    "msg": "file open error: open not-exist.txt: no such file or directory",
    "error": {
      "type": "*errors.errorString",
      "msg": "file open error"
    },
    "cause": {
      "type": "*fs.PathError",
      "msg": "open not-exist.txt: no such file or directory",
      "cause": {
        "type": "syscall.Errno",
        "msg": "no such file or directory"
      }
    },
    "context": {
      "function": "main.checkFileOpen",
      "path": "not-exist.txt"
    }
  },
  "file": "not-exist.txt"
}
```

ã¨ï¼Œã„ã„æ„Ÿã˜ã«æ§‹é€ åŒ–ã•ã‚Œã¦å‡ºåŠ›ã•ã‚Œã‚‹ã€‚

[Go]: https://go.dev/ "The Go Programming Language"
[for]: https://go.dev/ref/spec#For_statements "The Go Programming Language Specification - The Go Programming Language"
[spf13/cobra]: https://github.com/spf13/cobra "spf13/cobra: A Commander for modern Go CLI interactions"
[jq]: https://stedolan.github.io/jq/
[errs]: https://github.com/goark/errs "goark/errs: Error handling for Golang"
[errors]: https://pkg.go.dev/errors/ "errors - The Go Programming Language"
[json]: https://pkg.go.dev/encoding/json/ "json - The Go Programming Language"
[zerolog]: https://github.com/rs/zerolog "rs/zerolog: Zero Allocation JSON Logger"
[zapobject]: https://pkg.go.dev/github.com/goark/errs/zapobject "zapobject package - github.com/goark/errs/zapobject - Go Packages"
[zap]: https://pkg.go.dev/go.uber.org/zap "zap package - go.uber.org/zap - Go Packages"
[zapcore]: https://pkg.go.dev/go.uber.org/zap@v1.24.0/zapcore "zapcore package - go.uber.org/zap/zapcore - Go Packages"
