---
title: "github.com/pelletier/go-toml ã§éŠã¶" # è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«
emoji: "ğŸ’»" # ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹çµµæ–‡å­—ï¼ˆ1æ–‡å­—ã ã‘ï¼‰
type: "tech" # "tech" : æŠ€è¡“è¨˜äº‹ / "idea" : ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹
topics: ["go", "programming", "toml"] # ã‚¿ã‚°ã€‚["markdown", "rust", "aws"] ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹
published: true # å…¬é–‹è¨­å®šï¼ˆtrue ã§å…¬é–‹ï¼‰
---

[Hugo v0.87.0](https://github.com/gohugoio/hugo/releases/tag/v0.87.0 "Release v0.87.0 Â· gohugoio/hugo") ã§ [TOML] ã®æ“ä½œã« [github.com/pelletier/go-toml][pelletier/go-toml] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã«ã—ãŸã‚‰ã—ã„ã€‚

> we have switched to using [go-toml](https://github.com/pelletier/go-toml) for all things TOML in Hugo. A big thanks to [@pelletier](https://github.com/pelletier) for his work on the v2 version. It's both faster than what we had and [TOML v1.0.0](https://toml.io/en/v1.0.0) compliant.
>(via "[Release v0.87.0 Â· gohugoio/hugo](https://github.com/gohugoio/hugo/releases/tag/v0.87.0)")

ã¡ãªã¿ã«ï¼Œã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ v2 ç³»ãŒãƒ™ãƒ¼ã‚¿ç‰ˆå…¬é–‹ã•ã‚Œã¦ã„ã¦ [github.com/BurntSushi/toml][BurntSushi/toml] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚ˆã‚Š2å€ä»¥ä¸Šé€Ÿã„ã¨ã®ã“ã¨ï¼ˆvia "[Release v2.0.0-beta.3 Â· pelletier/go-toml](https://github.com/pelletier/go-toml/releases/tag/v2.0.0-beta.3)"ï¼‰ã€‚

| Benchmark                      | go-toml v1 | BurntSushi/toml |
| ------------------------------ | ---------: | --------------: |
| Marshal/HugoFrontMatter        |       2.0x |            2.0x |
| Marshal/ReferenceFile/map      |       1.8x |            2.0x |
| Marshal/ReferenceFile/struct   |       2.7x |            2.7x |
| Unmarshal/HugoFrontMatter      |       3.0x |            2.6x |
| Unmarshal/ReferenceFile/map    |       3.0x |            3.1x |
| Unmarshal/ReferenceFile/struct |       5.9x |            6.6x |

ã¨ã„ã†ã‚ã‘ã§ [pelletier/go-toml] ã‚’ä½¿ã£ã¦è»½ãéŠã‚“ã§ã¿ã‚ˆã†ã€‚

## [gpgpdump] è§£æçµæœã‚’ TOML ã§å‡ºåŠ›ã™ã‚‹

æ‹™ä½œã® [github.com/spiegel-im-spiegel/gpgpdump][gpgpdump] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ OpenPGP ãƒ‘ã‚±ãƒƒãƒˆã®è§£æçµæœã‚’ [TOML] å½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã‚‹[^toml1]ã€‚ãŸã¨ãˆã° [BurntSushi/toml] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨çµ„ã¿åˆã‚ã›ã¦

[^toml1]: [gpgpdump] ã®è§£æçµæœã‚’ TOML ã§å‡ºåŠ›ã™ã‚‹æ©Ÿèƒ½ã¯ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ç‰ˆã§ã¯ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã—ã¾ã£ãŸãŒ struct ã‚¿ã‚°ã¯æ®‹ã—ã¦ã„ã‚‹ã€‚

```go:sample0.go
// +build run

package main

import (
    "bytes"
    "fmt"
    "io"
    "os"
    "strings"

    "github.com/BurntSushi/toml"
    "github.com/spiegel-im-spiegel/gpgpdump/parse"
    "github.com/spiegel-im-spiegel/gpgpdump/parse/context"
)

const openpgpStr = `
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2

iF4EARMIAAYFAlTDCN8ACgkQMfv9qV+7+hg2HwEA6h2iFFuCBv3VrsSf2BREQaT1
T1ZprZqwRPOjiLJg9AwA/ArTwCPz7c2vmxlv7sRlRLUI6CdsOqhuO1KfYXrq7idI
=ZOTN
-----END PGP SIGNATURE-----
`

func main() {
    p, err := parse.New(
        context.New(
            context.Set(context.ARMOR, true),
            context.Set(context.UTC, true),
        ),
        strings.NewReader(openpgpStr),
    )
    if err != nil {
        fmt.Fprintf(os.Stderr, "%+v", err)
        return
    }
    res, err := p.Parse()
    if err != nil {
        fmt.Fprintf(os.Stderr, "%+v", err)
        return
    }
    buf := &bytes.Buffer{}
    if err := toml.NewEncoder(buf).Encode(res); err != nil {
        fmt.Fprintf(os.Stderr, "%+v", err)
        return
    }
    if _, err = io.Copy(os.Stdout, buf); err != nil {
        fmt.Fprintf(os.Stderr, "%+v", err)
        return
    }
}
```

ã¦ãªæ„Ÿã˜ã«æ›¸ã‘ã‚‹ã€‚å‡ºåŠ›çµæœã¯

```
$ go run sample0.go 
[[Packet]]
  name = "Signature Packet (tag 2)"
  note = "94 bytes"

  [[Packet.Item]]
    name = "Version"
    value = "4"
    note = "current"

  [[Packet.Item]]
    name = "Signiture Type"
    value = "Signature of a canonical text document (0x01)"

  [[Packet.Item]]
    name = "Public-key Algorithm"
    value = "ECDSA public key algorithm (pub 19)"

  [[Packet.Item]]
    name = "Hash Algorithm"
    value = "SHA2-256 (hash 8)"

  [[Packet.Item]]
    name = "Hashed Subpacket"
    note = "6 bytes"

    [[Packet.Item.Item]]
      name = "Signature Creation Time (sub 2)"
      value = "2015-01-24T02:52:15Z"

  [[Packet.Item]]
    name = "Unhashed Subpacket"
    note = "10 bytes"

    [[Packet.Item.Item]]
      name = "Issuer (sub 16)"
      value = "0x31fbfda95fbbfa18"

  [[Packet.Item]]
    name = "Hash left 2 bytes"
    dump = "36 1f"

  [[Packet.Item]]
    name = "ECDSA value r"
    note = "256 bits"

  [[Packet.Item]]
    name = "ECDSA value s"
    note = "252 bits"
```

ã¨ã„ã†æ„Ÿã˜ã€‚ã“ã‚Œã‚’ [pelletier/go-toml] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ç½®ãæ›ãˆã¦ã¿ã‚ˆã†ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ãƒ‘ã‚¹ã§

```go:sample1.go
import "github.com/pelletier/go-toml/v2"
```

ã¨ v2 ç³»ã‚’æŒ‡å®šã—ã¦ [BurntSushi/toml] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸéƒ¨åˆ†ã‚’æ›¸ãæ›ãˆã‚‹ã€‚

```go:sample1.go
b, err := toml.Marshal(res)
if err != nil {
    fmt.Fprintf(os.Stderr, "%+v", err)
    return
}
if _, err = bytes.NewReader(b).WriteTo(os.Stdout); err != nil {
    fmt.Fprintf(os.Stderr, "%+v", err)
    return
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã—ã¦ã¿ã‚ˆã†ã€‚

```
$ go run sample1.go 
[['Packet,omitempty']]
name = 'Signature Packet (tag 2)'
'value,omitempty' = ''
'dump,omitempty' = ''
'note,omitempty' = '94 bytes'
[['Packet,omitempty'.'Item,omitempty']]
name = 'Version'
'value,omitempty' = '4'
'dump,omitempty' = ''
'note,omitempty' = 'current'
'Item,omitempty' = []
[['Packet,omitempty'.'Item,omitempty']]
name = 'Signiture Type'
'value,omitempty' = 'Signature of a canonical text document (0x01)'
'dump,omitempty' = ''
'note,omitempty' = ''
'Item,omitempty' = []
[['Packet,omitempty'.'Item,omitempty']]
name = 'Public-key Algorithm'
'value,omitempty' = 'ECDSA public key algorithm (pub 19)'
'dump,omitempty' = ''
'note,omitempty' = ''
'Item,omitempty' = []
[['Packet,omitempty'.'Item,omitempty']]
name = 'Hash Algorithm'
'value,omitempty' = 'SHA2-256 (hash 8)'
'dump,omitempty' = ''
'note,omitempty' = ''
'Item,omitempty' = []
[['Packet,omitempty'.'Item,omitempty']]
name = 'Hashed Subpacket'
'value,omitempty' = ''
'dump,omitempty' = ''
'note,omitempty' = '6 bytes'
[['Packet,omitempty'.'Item,omitempty'.'Item,omitempty']]
name = 'Signature Creation Time (sub 2)'
'value,omitempty' = '2015-01-24T02:52:15Z'
'dump,omitempty' = ''
'note,omitempty' = ''
'Item,omitempty' = []

[['Packet,omitempty'.'Item,omitempty']]
name = 'Unhashed Subpacket'
'value,omitempty' = ''
'dump,omitempty' = ''
'note,omitempty' = '10 bytes'
[['Packet,omitempty'.'Item,omitempty'.'Item,omitempty']]
name = 'Issuer (sub 16)'
'value,omitempty' = '0x31fbfda95fbbfa18'
'dump,omitempty' = ''
'note,omitempty' = ''
'Item,omitempty' = []

[['Packet,omitempty'.'Item,omitempty']]
name = 'Hash left 2 bytes'
'value,omitempty' = ''
'dump,omitempty' = '36 1f'
'note,omitempty' = ''
'Item,omitempty' = []
[['Packet,omitempty'.'Item,omitempty']]
name = 'ECDSA value r'
'value,omitempty' = ''
'dump,omitempty' = ''
'note,omitempty' = '256 bits'
'Item,omitempty' = []
[['Packet,omitempty'.'Item,omitempty']]
name = 'ECDSA value s'
'value,omitempty' = ''
'dump,omitempty' = ''
'note,omitempty' = '252 bits'
'Item,omitempty' = []
```

ã‚ã‚Šã‚ƒã‚Šã‚ƒãƒ¼ã‚“ã€‚ Struct ã‚¿ã‚°ã® `omitempty` ã‚’è§£é‡ˆã—ã¦ãã‚Œãªã„ã‚“ã ãª[^toml2] orz

[^toml2]: [pelletier/go-toml]/v2 ã® [toml][pelletier/go-toml].Unmarshal() / [toml][pelletier/go-toml].Decoder.Decode() å„é–¢æ•°ã‚‚ `omitempty` ã‚’è§£é‡ˆã—ã¦ãã‚Œãªã„ã‚ˆã†ã ã€‚

ã¾ï¼Œã¾ãï¼Œç‰¹å®šã®æ§‹é€ ä½“ã§ã¯ãªã map[string]interface{} ã‚’ä½¿ã†æ‰‹ã‚‚ã‚ã‚‹ã®ã ãŒ... ã¡ãªã¿ã« import å®£è¨€ã‚’

```go
import "github.com/pelletier/go-toml"
```

ã¨ v1 ç³»ã«ã™ã‚Œã° [BurntSushi/toml] ã¨åŒç­‰ã®å‡ºåŠ›ã«ãªã‚‹ï¼ˆã§ã‚‚é…ã„ï¼Œå¤šåˆ†ï¼‰ã€‚

## ã€ãŠã¾ã‘ã€‘ [jq] é¢¨ã®ã‚¯ã‚¨ãƒª

[pelletier/go-toml] v1 ç³»ã«ã¯ [jq] é¢¨ã®ã‚¯ã‚¨ãƒªã‚’ä½¿ã£ã¦ [TOML] ã®å†…å®¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚‹ã€‚ã“ã‚Œã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ãŸã€‚

```go:sample2.go
// +build run

package main

import (
    "flag"
    "fmt"
    "os"

    "github.com/pelletier/go-toml"
    "github.com/pelletier/go-toml/query"
)

func main() {
    flag.Parse()
    args := flag.Args()
    if len(args) != 1 {
        fmt.Fprintln(os.Stderr, os.ErrInvalid)
        return
    }

    info, err := toml.LoadReader(os.Stdin)
    if err != nil {
        fmt.Fprintln(os.Stderr, err)
        return
    }

    results, err := query.CompileAndExecute(args[0], info)
    if err != nil {
        fmt.Fprintln(os.Stderr, err)
        return
    }
    for _, item := range results.Values() {
        fmt.Println(item)
    }
}
```

ãŸã¨ãˆã°ï¼Œæœ€åˆã«æ›¸ã„ãŸ sample0.go ã®å®Ÿè¡Œçµæœã‚’ã“ã® sample2.go ã«ãƒ‘ã‚¤ãƒ—ã§ç¹‹ã’ã°

```
$ go run sample0.go | go run sample2.go "$.Packet[0].Item[0]"
name = "Version"
note = "current"
value = "4"
```

ã¦ãªæ„Ÿã˜ã§è©•ä¾¡ã§ãã‚‹ã€‚

## å‚è€ƒ

https://text.baldanders.info/release/gpgpdump/

[Go]: https://golang.org/ "The Go Programming Language"
[Hugo]: https://gohugo.io/ "The worldâ€™s fastest framework for building websites | Hugo"
[pelletier/go-toml]: https://github.com/pelletier/go-toml "pelletier/go-toml: Go library for the TOML file format"
[BurntSushi/toml]: https://github.com/BurntSushi/toml "BurntSushi/toml: TOML parser for Golang with reflection."
[TOML]: https://toml.io/ "TOML: Tom's Obvious Minimal Language"
[gpgpdump]: https://github.com/spiegel-im-spiegel/gpgpdump "spiegel-im-spiegel/gpgpdump: OpenPGP packet visualizer"
[jq]: https://stedolan.github.io/jq/
<!-- eof -->
