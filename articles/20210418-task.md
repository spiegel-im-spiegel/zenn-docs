---
title: "Make ã®ä»£ã‚ã‚Šã« Task ã‚’ä½¿ã£ã¦ã¿ã‚‹"
emoji: "ğŸ’®" # ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹çµµæ–‡å­—ï¼ˆ1æ–‡å­—ã ã‘ï¼‰
type: "idea" # "tech" : æŠ€è¡“è¨˜äº‹ / "idea" : ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹
topics: ["programming"] # ã‚¿ã‚°ã€‚["markdown", "rust", "aws"] ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹
published: true # å…¬é–‹è¨­å®šï¼ˆtrue ã§å…¬é–‹ï¼‰
---

Twitter ã® TL ã§è¦‹ã‹ã‘ãŸã®ã ãŒï¼Œåå‰ã‚‚ãã®ã¾ã‚“ã¾ [Task] ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ãŒã‚ã‚‹ã‚‰ã—ã„ï¼ˆDocker é–¢é€£ã§ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹ï¼Ÿï¼‰ã€‚ [Task] ã®ç‰¹å¾´ã¯

> - Easy installation: just download a single binary, add to $PATH and youâ€™re done! Or you can also install using Homebrew, Snapcraft, or Scoop if you want;
> - Available on CIs: by adding this simple command to install on your CI script and youâ€™re done to use Task as part of your CI pipeline;
> - Truly cross-platform: while most build tools only work well on Linux or macOS, Task also supports Windows thanks to this awesome shell interpreter for Go;
> - Great for code generation: you can easily prevent a task from running if a given set of files havenâ€™t changed since last run (based either on its timestamp or content).

ã¨ã®ã“ã¨ã§ï¼Œã‚ã®é¬±é™¶ã—ã„ make ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ç½®ãæ›ãˆã¦ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã‚‰ã—ã„ã€‚ãƒ›ãƒ³ãƒã‹ãªï¼Ÿ è©¦ã—ã¦ã¿ã‚ˆã†ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[Task] ã¯ Homebrew, Snap, Scoop ç­‰ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã€‚ Scoop ã‚’ä½¿ã†å ´åˆã¯

```
$ scoop bucket add extras
$ scoop install task
```

ã¨ extras ãƒã‚±ãƒƒãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ãªã‚ˆã†ã ã€‚ã¾ãŸ GitHub Actions ã§ã¯

```yaml
- name: Install Task
  uses: Arduino/actions/setup-taskfile@master
```

ã¦ãªæ„Ÿã˜ã«çµ„ã¿è¾¼ã‚ã‚‹ã€‚

Go ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã¯ GitHub ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰

```
$ go install github.com/go-task/task/v3/cmd/task@latest
```

ã§ãƒ“ãƒ«ãƒ‰&ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã€‚

## ã¿ã‚“ãªå¤§å¥½ã Hello World

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã§ããŸã¨ã“ã‚ã§ï¼Œç°¡å˜ãªæ‰‹é †ã‚’æ›¸ã„ã¦å®Ÿè¡Œã—ã¦ã¿ã‚ˆã†ã€‚

[Task] ã§æ‰‹é †ã‚’æŒ‡ç¤ºã™ã‚‹ã«ã¯ Taskfile.yml ãƒ•ã‚¡ã‚¤ãƒ«ã« YAML å½¢å¼ã§è¨˜è¿°ã™ã‚‹[^tf1]ã€‚ãŸã¨ãˆã°ã“ã‚“ãªæ„Ÿã˜ã€‚

```yaml:Taskfile.yml
version: '3'

tasks:
  default:
    cmds:
      - echo Hello, World!
```

[^tf1]: ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®è¦å®šã®åå‰ã¯ taskfile.yml ã§ã¯ãªã Taskfile.yml ãªã®ã§æ³¨æ„ã€‚ãªãŠ `--taskfile` (çŸ­ç¸®å `-t`) ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚

ã“ã‚Œã§ [Task] ã‚’å®Ÿè¡Œã™ã‚‹ã¨

```
$ task
task: [default] echo Hello, World!
Hello, World!
```

ã¨ãªã£ãŸã€‚

ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§ã‚¿ã‚¹ã‚¯åã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚ãŸã¨ãˆã°ï¼Œã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’

```yaml:Taskfile.yml
version: '3'

tasks:
  default:
    deps:
      - task: hello
        vars:
          RECIPIENT: "World"
  hello:
    vars:
      RECIPIENT: '{{default "there" .RECIPIENT}}'
    cmds:
      - echo Hello, {{.RECIPIENT}}!
```

ã¨æ›¸ãæ›ãˆã¦å®Ÿè¡Œã™ã‚‹ã¨

```
$ task hello
task: [hello] echo Hello, there!
Hello, there!
```

ã¨ãªã‚‹ã€‚ã¾ãŸï¼ŒåŒã˜ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã§å¼•æ•°ãªã—ã§å®Ÿè¡Œã™ã‚‹ã¨

```
$ task
task: [hello] echo Hello, World!
Hello, World!
```

ã¨ãªã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/nzqq9pqm6vw8qjlyepbznwl56u1o)

ã¨ã„ã†ä¾å­˜é–¢ä¿‚ã§ default ã‚¿ã‚¹ã‚¯ã‹ã‚‰ hello ã‚¿ã‚¹ã‚¯ã« RECIPIENT å¤‰æ•°ã‚’æ¸¡ã—ã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã¨æ€ã†ã€‚

ã¡ãªã¿ã« `{{...}}` ã¨ã„ã†ã®ã¯ Go ã®[æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](https://golang.org/pkg/text/template/ "template - The Go Programming Language")ã®è¨˜è¿°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã‚ã‚‹ã€‚ Go ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚¯ã‚»ãŒã‚ã‚‹ãŒæ…£ã‚Œã‚‹ã¨å‰²ã¨ä¾¿åˆ©ãªã®ã§ï¼Œèˆˆå‘³ãŒã‚ã‚Œã°èª¿ã¹ã¦ã¿ã‚‹ã®ã‚‚ã„ã„ã ã‚ã†ã€‚ã¨ã‚Šã‚ãˆãšã¯ã€Œãã†ã„ã†ã‚‚ã‚“ã ã€ã¨è¦šãˆã¦ãŠã„ã¦æ¬²ã—ã„ã€‚

## Makefile ã‚’ Taskfile.yml ã«ç½®ãæ›ãˆã‚Œã‚‹ã‹

æ¬¡ã« make ã‚’ä½¿ã£ãŸå‡¦ç†ã‚’ [Task] ã§ç½®ãæ›ãˆã‚Œã‚‹ã‹è©¦ã—ã¦ã¿ã‚‹ã€‚é©å½“ãªä¾‹ãŒæ€ã„æµ®ã‹ã°ãªã‹ã£ãŸã®ã§ï¼Œå±±æœ¬å’Œå½¦ã•ã‚“ã® [kazu-yamamoto/pgpdump] ã§è©¦ã—ã¦ã¿ã‚‹ã€‚

[kazu-yamamoto/pgpdump] ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–ã£ã¦ãã¦ configure ã§ Makefile ã‚’ç”Ÿæˆã—ãŸçµæœãŒä»¥ä¸‹ã®é€šã‚Šã€‚

```makefile:Makefile
prefix = /usr/local
exec_prefix = ${prefix}
bindir = ${exec_prefix}/bin
mandir = ${prefix}/share/man
LIBS = -lbz2 -lz 
CFLAGS  = -g -O2 -O -Wall
LDFLAGS = 
CC = gcc
VERSION = `git tag | tail -1 | sed -e 's/v//'`

RM = rm -f
INSTALL  = install

INCS = pgpdump.h
SRCS = pgpdump.c types.c tagfuncs.c packet.c subfunc.c signature.c keys.c \
       buffer.c uatfunc.c
OBJS = pgpdump.o types.o tagfuncs.o packet.o subfunc.o signature.o keys.o \
       buffer.o uatfunc.o
PROG = pgpdump

MAN  = pgpdump.1

CNF = config.h config.status config.cache config.log
MKF = Makefile

.c.o:
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $<

all: $(PROG)

$(PROG): $(OBJS)
	$(CC) $(CFLAGS) -o $(PROG) $(OBJS) $(LIBS) $(LDFLAGS)

clean:
	$(RM) $(OBJS) $(PROG)

distclean:
	$(RM) $(OBJS) $(PROG) $(CNF) $(MKF)

install: all
	$(INSTALL) -d $(DESTDIR)$(bindir)
	$(INSTALL) -cp -pm755 $(PROG) $(DESTDIR)$(bindir)
	$(INSTALL) -d $(DESTDIR)$(mandir)/man1
	$(INSTALL) -cp -pm644 $(MAN) $(DESTDIR)$(mandir)/man1

archive:
	git archive master -o ~/pgpdump-$(VERSION).tar --prefix=pgpdump-$(VERSION)/
	gzip ~/pgpdump-$(VERSION).tar
```

ã“ã®å†…å®¹ã‚’åŸºã«ï¼Œä»Šå›ã¯ *.c ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦å®Ÿè¡Œãƒã‚¤ãƒŠãƒªã‚’ç”Ÿæˆã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚’è¨˜è¿°ã—ã¦ã¿ã‚‹ã€‚ã“ã‚“ãªæ„Ÿã˜ã‹ãªã€‚

```yaml:Taskfile.yml
version: '3'

vars:
  LIBS: -lbz2 -lz
  CFLAGS : -g -O2 -O -Wall
  LDFLAGS:
  INCS: pgpdump.h
  CC: gcc
  SRCS: |
    pgpdump.c
    types.c
    tagfuncs.c
    packet.c
    subfunc.c
    signature.c
    keys.c
    buffer.c
    uatfunc.c
  OBJS: pgpdump.o types.o tagfuncs.o packet.o subfunc.o signature.o keys.o buffer.o uatfunc.o
  PROG: pgpdump

tasks:
  default:
    deps: [link]

  c-compile:
    cmds:
      - |
        {{range .SRCS | splitLines -}}
        {{if .}}{{$.CC}} -c {{$.CFLAGS}} {{.}}{{end}}
        {{end -}}
    sources:
      - '{{.INCS}}'
      - ./*.c
    generates:
      - ./*.o
    method: checksum

  link:
    deps: [c-compile]
    cmds:
      - '{{.CC}} {{.CFLAGS}} -o {{.PROG}}{{exeExt}} {{.OBJS}} {{.LIBS}} {{.CFLAGS}}'
    sources:
      - ./*.o
    generates:
      - '{{.PROG}}{{exeExt}}'
    method: checksum
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨

```
$ task
task: [c-compile] gcc -c -g -O2 -O -Wall pgpdump.c
gcc -c -g -O2 -O -Wall types.c
gcc -c -g -O2 -O -Wall tagfuncs.c
gcc -c -g -O2 -O -Wall packet.c
gcc -c -g -O2 -O -Wall subfunc.c
gcc -c -g -O2 -O -Wall signature.c
gcc -c -g -O2 -O -Wall keys.c
gcc -c -g -O2 -O -Wall buffer.c
gcc -c -g -O2 -O -Wall uatfunc.c


task: [link] gcc -g -O2 -O -Wall -o pgpdump pgpdump.o types.o tagfuncs.o packet.o subfunc.o signature.o keys.o buffer.o uatfunc.o -lbz2 -lz -g -O2 -O -Wall
```

ã¦ãªæ„Ÿã˜ã«ãªã‚‹ã€‚ãã®ã¾ã¾ã‚‚ã†ä¸€åº¦å®Ÿè¡Œã™ã‚‹ã¨

```
$ task
task: Task "c-compile" is up to date
task: Task "link" is up to date
```

ãªã©ã¨å†å®Ÿè¡ŒãŒæŠ‘æ­¢ã•ã‚Œã‚‹ã€‚ã“ã“ã¾ã§ã©ãˆã‚‰è‹¦åŠ´ã—ãŸã‚ˆã€‚

æ°—ãŒä»˜ã„ãŸç‚¹ã‚’ã‹ã„ã¤ã¾ã‚“ã§æŒ™ã’ã‚‹ã¨

- åˆ†å²ã‚„ç¹°ã‚Šè¿”ã—ã¨ã„ã£ãŸåˆ¶å¾¡æ§‹é€ ãŒãªã„
  - å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ã‚„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦æ“¬ä¼¼çš„ãªåˆ¶å¾¡ã¯ã§ãã‚‹
- `vars` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§å®šç¾©ã§ãã‚‹å¤‰æ•°ã®å€¤ã‚‚æ§‹é€ åŒ–ã§ããªã„
- `sources` ãŠã‚ˆã³ `generates` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¿ã‚¹ã‚¯ã”ã¨ã«ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä¿æŒã£ã¦æ›´æ–°ã®æœ‰ç„¡ã‚’èª¿ã¹ã‚‹
  - ãƒãƒƒã‚·ãƒ¥å€¤ã¯ .task/cheksum ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¿ã‚¹ã‚¯ã”ã¨ã«ä¿æŒã™ã‚‹
  - `method` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã‚’ `timestamp` ã¨ã™ã‚‹ã¨`sources` ã¨ `generates` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ¯”è¼ƒã—ã¦æ›´æ–°ã‚’åˆ¤å®šã™ã‚‹ã€‚ã“ã®å ´åˆ .task ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«ã‚¢ã‚¯ã‚»ã‚¹ã¯ã—ãªã„ã‚ˆã†ã 

åˆ¶å¾¡ã‚‚å¤‰æ•°ã‚‚æ§‹é€ åŒ–ã§ããªã„ãŸã‚ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ã®ç´°ã‹ã„åˆ¶å¾¡ãŒé›£ã—ã„ã€‚ãŸã¨ãˆã°ï¼Œæ‰‹é †ã‚’ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«æ¯ã«ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã—ã¦

```yaml
  pgpdump:
    vars:
      SRC: "pgpdump"
    cmds:
      - '{{$.CC}} -c {{$.CFLAGS}} {{.SRC}}.c'
    sources:
      - '{{.INCS}}'
      - '{{.SRC}}.c'
    generates:
      - '{{.SRC}}.o'
    method: checksum
```

ã®ã‚ˆã†ã«æ›¸ã‘ã°ã§ããªãã‚‚ãªã„ãŒï¼Œå†—é•·ã™ãã‚‹ã‚ˆã­ã‡ã€‚

Make ã‚³ãƒãƒ³ãƒ‰ãŠã‚ˆã³ Makefile ã¯ä¾å­˜é–¢ä¿‚ã«ç´ã¥ãåˆ¶å¾¡ã‚’æ‹¡å¼µå­å˜ä½ã§æ±åŒ–ã§ãã‚‹ã®ãŒç‰¹å¾´ã§ã‚ã‚‹ã€‚è¨€ã„æ–¹ã‚’å¤‰ãˆã‚‹ã¨ãã‚Œã—ã‹å–ã‚ŠæŸ„ãŒãªã„ã€‚ä¸€æ–¹ã§ [Task] ã¯å˜ç´”ãªåˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã¯æ›¸ãã‚„ã™ã„ãŒï¼Œæ‰‹é †ã‚’ï¼ˆä¾å­˜é–¢ä¿‚ã¨å…±ã«ï¼‰ãƒ«ãƒ¼ãƒ«ã¨ã—ã¦æ±åŒ–ã§ããªã„ãŸã‚ï¼Œã©ã†ã—ã¦ã‚‚è¨˜è¿°ãŒç…©é›‘ã«ãªã£ã¦ã—ã¾ã†ã€‚

[Task] ã¯ make ã‚³ãƒãƒ³ãƒ‰ã®ä»£æ›¿ã¨ã„ã†ã‚ˆã‚Šã¯ç›¸è£œçš„ãªä½ç½®ä»˜ã‘ã¨ã—ã¦è€ƒãˆã‚‹ã®ãŒã„ã„ã ã‚ã†ã€‚ã‚ã¨ YAML ã¯æœ¬å½“ã«é¢å€’ã€‚ã¤ã‹ï¼Œæ‰‹é †ã‚’è¨˜è¿°ã™ã‚‹ã®ã« YAML ã¯å‘ã„ã¦ãªã„ã‚“ã˜ã‚ƒãªã„ã®ã‹ãªã...

[Task]: https://taskfile.dev/
[kazu-yamamoto/pgpdump]: https://github.com/kazu-yamamoto/pgpdump "kazu-yamamoto/pgpdump: A PGP packet visualizer"
<!-- eof -->
