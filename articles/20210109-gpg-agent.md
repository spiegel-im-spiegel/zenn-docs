---
title: "Ubuntu ã§ OpenSSH ã®éµç®¡ç†ã‚’ gpg-agent ã«å§”è­²ã™ã‚‹ã€ãŸã¶ã‚“æ±ºå®šç‰ˆã€‘" # è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«
emoji: "ğŸ”" # ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹çµµæ–‡å­—ï¼ˆ1æ–‡å­—ã ã‘ï¼‰
type: "idea" # "tech" : æŠ€è¡“è¨˜äº‹ / "idea" : ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹
topics: ["cryptography","ssh","gnupg","ubuntu"] # ã‚¿ã‚°ã€‚["markdown", "rust", "aws"] ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹
published: true # å…¬é–‹è¨­å®šï¼ˆtrue ã§å…¬é–‹ï¼‰
---

[OpenSSH] ã§ã¯ ssh-agent ã‚’ [GnuPG] ã® gpg-agent ã«ç½®ãæ›ãˆã‚‹ã“ã¨ã§éµã®ç®¡ç†ã‚’ [GnuPG] å´ã«å§”è­²ã§ãã‚‹ã€‚ã¡ãªã¿ã« gpg-agent ã¯ [GnuPG] ç§˜å¯†éµç®¡ç†ã®ä¸­æ ¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ï¼Œè‡ªèº«ã¯ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ä¸€å®šæœŸé–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§ãƒ¦ãƒ¼ã‚¶ã®éµæ“ä½œã‚’çœåŠ›åŒ–ã§ãã‚‹ï¼ˆç§˜å¯†éµãã®ã‚‚ã®ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„ï¼‰ã€‚ã¾ãŸï¼Œãƒªãƒ¢ãƒ¼ãƒˆã® gpg-agent åŒå£«ã®é€£æºã‚‚å¯èƒ½ã§ã‚ã‚‹ã€‚

ãŸã ã— Ubuntu ã‚’å«ã‚€ Debian ç³»ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ [OpenSSH] ã®éµç®¡ç†ã« ssh-agent ã‚’ä½¿ã†ã“ã¨ã‚’å‰æã«æ§‹æˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼Œ gpg-agent ã«ç½®ãæ›ãˆã‚‹ã«ã¯ã„ãã¤ã‹ã®è¨­å®šå¤‰æ›´ãŒå¿…è¦ãªã‚ˆã†ã ã€‚ã“ã®è¨˜äº‹ã§ã¯ï¼Œãã®è¨­å®šå¤‰æ›´ã«ã¤ã„ã¦ç°¡å˜ã«ã¾ã¨ã‚ã¦ãŠã[^win1]ã€‚

[^win1]: Windows ã®å ´åˆã¯ï¼Œå¤ã„è¨˜äº‹ã§æç¸®ã ãŒï¼Œæ‹™æ–‡ã€Œ[GnuPG for Windows : gpg-agent ã«ã¤ã„ã¦](https://text.baldanders.info/openpgp/using-gnupg-for-windows-2/)ã€ã‚’å‚ç…§ã®ã“ã¨ã€‚

## Ubuntu è¨­å®šã®å¤‰æ›´

### gpg-agent ã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèª

ã¾ãšã¯ gpg-agent ãŒã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ç¨¼åƒã—ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚

```
$ systemctl --user status gpg-agent
â— gpg-agent.service - GnuPG cryptographic agent and passphrase cache
     Loaded: loaded (/usr/lib/systemd/user/gpg-agent.service; static)
     Active: inactive (dead)
TriggeredBy: â— gpg-agent-extra.socket
             â— gpg-agent-browser.socket
             â— gpg-agent-ssh.socket
             â— gpg-agent.socket
       Docs: man:gpg-agent(1)
```

ä¸Šã¯ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã§ gpg-agent ãŒèµ·å‹•ã—ã¦ã„ãªã„çŠ¶æ…‹ã ãŒï¼Œ `TriggeredBy` ãŒç¤ºã™4ã¤ã®ã‚½ã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã§èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚ã“ã®ã‚½ã‚±ãƒƒãƒˆã®ä¸­ã« `gpg-agent-ssh.socket` ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ç„¡å•é¡Œã€‚ã¡ãªã¿ã«ã‚½ã‚±ãƒƒãƒˆã®å®Ÿä½“ã¯ gpgconf ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã‚‹ã€‚

```
$ gpgconf --list-dirs | grep socket
socketdir:/run/user/1000/gnupg
dirmngr-socket:/run/user/1000/gnupg/S.dirmngr
agent-ssh-socket:/run/user/1000/gnupg/S.gpg-agent.ssh
agent-extra-socket:/run/user/1000/gnupg/S.gpg-agent.extra
agent-browser-socket:/run/user/1000/gnupg/S.gpg-agent.browser
agent-socket:/run/user/1000/gnupg/S.gpg-agent
```

### Xsession.options ã®å¤‰æ›´

æ¬¡ã« /etc/X11/Xsession.options ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹ã€‚

```bash:/etc/X11/Xsession.options
# $Id: Xsession.options 189 2005-06-11 00:04:27Z branden $
#
# configuration options for /etc/X11/Xsession
# See Xsession.options(5) for an explanation of the available options.
allow-failsafe
allow-user-resources
allow-user-xsession
use-ssh-agent
use-session-dbus
```

ã“ã®ä¸­ã® `use-ssh-agent` ã®è¨˜è¿°ã‚’ `no-use-ssh-agent` ã«å·®ã—æ›¿ãˆã‚‹ã€‚å½“ç„¶ãªãŒã‚‰å¤‰æ›´ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ãªã®ã§ã”æ³¨æ„ã‚’ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚ŠãªãŒã‚‰ä½œæ¥­ã—ã¦ã­ã€‚

### gnome-keyring-ssh.desktop ã‚’ autostart ã«å…¥ã‚Œã‚‹

/etc/xdg/autostart/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« gnome-keyring-ssh.desktop ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã ãŒï¼Œã¾ãšã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ ~/.config/autostart/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã„å ´åˆã¯ä½œæˆã™ã‚‹ã“ã¨ã€‚

```
$ cp /etc/xdg/autostart/gnome-keyring-ssh.desktop ~/.config/autostart/
```

gnome-keyring-ssh.desktop ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã¯ãƒ†ã‚­ã‚¹ãƒˆã ãŒï¼Œã‚³ãƒ”ãƒ¼ã—ãŸã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾ã«

```ini
Hidden=true
```

ã®è¡Œã‚’è¿½è¨˜ã™ã‚‹ã€‚

#### ã€2021-06-05 è¿½è¨˜ã€‘ Ubuntu 21.04 ã®å ´åˆ

2021å¹´4æœˆã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ Ubuntu 21.04 ã§ã¯ã“ã®è¨­å®šã§ã¯ã†ã¾ãè¡Œã‹ãªã„ã‚ˆã†ã ã€‚

ã¾ãš ~/.config/autostart/gnome-keyring-ssh.desktop ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®è¨˜è¿°ã‚’è¿½åŠ ã—ã¦å®Œå…¨ã«è¨­å®šã‚’ç„¡åŠ¹ã«ã™ã‚‹ã€‚

```ini
X-GNOME-Autostart-enabled=false
```

ã•ã‚‰ã« .bashrc ãªã©ã§

```bash
export SSH_AUTH_SOCK="$(gpgconf --list-dirs agent-ssh-socket)"
```

ã¨è¨€ã£ãŸæ„Ÿã˜ã«ç’°å¢ƒå¤‰æ•° SSH_AUTH_SOCK ã‚’ç›´æ¥æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¿ãŸã„ã€‚å›°ã‚‹ãªã...

### gpg-agent.conf ã®è¨­å®š

æœ€å¾Œã« ~/.gnupg/gpg-agent.conf ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®å†…å®¹ã‚’æ›¸ãè¾¼ã‚€ã€‚ gpg-agent.conf ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ä½œæˆã—ã¦ã­ã€‚

```bash:~/.gnupg/gpg-agent.conf
enable-ssh-support
default-cache-ttl-ssh 1800
max-cache-ttl-ssh 7200
```

ä¸‹2ã¤ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä»»æ„ã§ï¼Œä»¥ä¸‹ã®æ„å‘³ã‚’æŒã¤ã€‚

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³å            | å†…å®¹ |
|-------------------------|------|
| `default-cache-ttl-ssh` | ç›´å‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ã‚¨ãƒ³ãƒˆãƒªã®æœ‰åŠ¹æœŸé–“ã‚’ç§’å˜ä½ã§æŒ‡å®šã™ã‚‹ã€‚ æ—¢å®šå€¤ã¯ 1800 |
| `max-cache-ttl-ssh`     | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ã‚¨ãƒ³ãƒˆãƒªã®æœ‰åŠ¹æœŸé–“ã®æœ€å¤§å€¤ã‚’ç§’å˜ä½ã§æŒ‡å®šã™ã‚‹ã€‚ ã‚¢ã‚¯ã‚»ã‚¹ã®æœ‰ç„¡ã«ã‹ã‹ã‚ã‚‰ãšã“ã®æœŸé–“ãŒéãã‚‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã€‚ æ—¢å®šå€¤ã¯ 7200 |

æœ‰åŠ¹æœŸé–“ã¯å¤§ãã™ãã‚‹ã¨æ¼æ´©ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚‹ã®ã§ã»ã©ã»ã©ã«ï¼ˆç¬‘ï¼‰

ã“ã‚Œã§è¨­å®šã¯å®Œäº†ã€‚å¿µã®ãŸã‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãŠã“ã†ã€‚

### ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª

ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ãŸã‚‰ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã—ã¦ãŠãã€‚

```
$ env | grep SSH
SSH_AUTH_SOCK=/run/user/1000/gnupg/S.gpg-agent.ssh
```

ã¦ãªæ„Ÿã˜ã« SSH_AUTH_SOCK ç’°å¢ƒå¤‰æ•°ã®å€¤ãŒ gpg-agent ã®ã‚½ã‚±ãƒƒãƒˆã«ãªã£ã¦ã„ã‚Œã° OK ã§ã‚ã‚‹ã€‚

## [GnuPG] ã«ã‚ˆã‚‹éµç®¡ç†

### æ—¢å­˜ã® [OpenSSH] èªè¨¼éµã‚’ç™»éŒ²ã™ã‚‹

ä¸Šè¿°ã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚Œã°ï¼Œæ—¢å­˜ã® [OpenSSH] èªè¨¼éµã‚’ [GnuPG] ã®éµæŸã«ç™»éŒ²ã™ã‚‹ã®ã¯ ssh-add ã‚³ãƒãƒ³ãƒ‰ã§ç°¡å˜ã«ã§ãã‚‹ã€‚

```
$ ssh-add ./id_ecdsa
Enter passphrase for ./id_ecdsa: 
Identity added: ./id_ecdsa (alice@example.com)
```

ã“ã®æ™‚ ssh-add ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå…¥åŠ›ã¨ã¯åˆ¥ã« GnuPG ã® Pinentry ã«ã‚ˆã‚‹ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã®è¨­å®šãŒè¡Œã‚ã‚Œã‚‹ï¼ˆç¢ºèªã‚’å«ã‚ã¦2ç®‡æ‰€å…¥åŠ›ã™ã‚‹å¿…è¦ã‚ã‚Šï¼‰ã€‚

[![Pinentry](https://text.baldanders.info/remark/2020/06/upgrade-openssh-key/pinentry.png)](https://text.baldanders.info/remark/2020/06/upgrade-openssh-key/pinentry.png)

[GnuPG] ã®éµæŸã«ç™»éŒ²ã•ã‚Œã‚‹èªè¨¼éµã¯ã“ã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã§ä¿è­·ã•ã‚Œã‚‹ã€‚

å¤§äº‹ãªã“ã¨ãªã®ã§ç¹°ã‚Šè¿”ã™ãŒï¼Œç™»éŒ²ã—ãŸç§˜å¯†éµã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œãš [GnuPG] ã®éµæŸï¼ˆ~/.gnupg/private-keys-v1.d/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰ã«å…¥ã‚‹ã€‚ã¾ãŸ ~/.gnupg/sshcontrol ãƒ•ã‚¡ã‚¤ãƒ«ã«

```bash
# ECDSA key added on: 2020-06-01 14:05:35
# Fingerprints:  MD5:e4:5b:66:a6:03:9a:a4:0e:f2:1b:a5:04:72:93:f3:f0
#                SHA256:DtXgQm9rz7Dc5M5yWu/CNVo341o1rcfN9UCyYu+SZU4
A5353D587000D820669B0BD55A0B4AD6897458DB 0
```

ã¨ã„ã†æ„Ÿã˜ã«è¿½åŠ ã—ãŸéµã®æƒ…å ±ãŒå…¥ã‚‹ã€‚

ã¡ãªã¿ã« `A5353D587000D820669B0BD55A0B4AD6897458DB` ã¯ keygrip ã¨å‘¼ã°ã‚Œã‚‹å€¤ã§ï¼Œéµã®ç¨®é¡ã«é–¢ä¿‚ãªãçµ±ä¸€çš„ã«è¡¨ã•ã‚Œã‚‹ ID ã§ã‚ã‚‹ã€‚ã¾ãŸéµæŸã§ã‚ã‚‹ ~/.gnupg/private-keys-v1.d/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å…¥ã£ã¦ã„ã‚‹éµã¯ A5353D587000D820669B0BD55A0B4AD6897458DB.key ã®ã‚ˆã†ã« keygrip ã«ç´ä»˜ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«åã§æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã€‚ã¾ãŸï¼Œæœ«å°¾ã® `0` ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé–“ï¼ˆç§’ï¼‰ã‚’æŒ‡ã™ã‚‰ã—ã„ã€‚ `0` ã‚ˆã‚Šå¤§ãã‘ã‚Œã° gpg-agent.conf ãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®šã‚ˆã‚Šå„ªå…ˆã•ã‚Œã‚‹ã£ã¦ã“ã¨ã‹ãªã€‚

ãªãŠï¼Œè¡Œé ­ã« `!` ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã‚‹ã¨éµã®ä½¿ç”¨ã‚’ç„¡åŠ¹åŒ–ã§ãã‚‹ã€‚

### [GnuPG] éµã‚’ [OpenSSH] èªè¨¼éµã¨ã—ã¦è¨­å®šã™ã‚‹

[GnuPG] éµã‚’ [OpenSSH] èªè¨¼éµã¨ã—ã¦è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚ãŸã ã—å°‚ç”¨ã®èªè¨¼éµã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚è©³ã—ãã¯æ‹™æ–‡

https://text.baldanders.info/openpgp/ssh-key-management-with-gnupg/

ã‚’å‚è€ƒã«ã©ã†ãã€‚ãŸã¨ãˆã°

```
$ gpg --list-keys --with-keygrip alice
pub   ed25519 2021-01-06 [SC] [æœ‰åŠ¹æœŸé™: 2021-01-13]
      011C720B03D2E1D6BCFA98391DFF44901121B61D
      Keygrip = 97249ABEB2A2FD9E88F6723BB19D4F84B90E261A
uid           [  ç©¶æ¥µ  ] Alice <alice@example.com>
sub   cv25519 2021-01-06 [E]
      Keygrip = 96CB831965E1A7EB4705577D6A7CB7F9E05C8192
sub   ed25519 2021-01-06 [A]
      Keygrip = F5C774B5B418B6E0B5B7942F93DE82BF2FEF4C8E
```

ã¨ã„ã†éµãŒã‚ã‚‹ã¨ãï¼Œæœ€å¾Œã® `[A]` ã§ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ã‚‹å‰¯éµãŒ [OpenSSH] èªè¨¼éµã¨ã—ã¦ä½¿ãˆã‚‹ã®ã ãŒï¼Œã“ã®éµã® keygrip å€¤ã‚’ ~/.gnupg/sshcontrol ãƒ•ã‚¡ã‚¤ãƒ«ã«ç™»éŒ²ã™ã‚‹ã€‚

```
$ echo F5C774B5B418B6E0B5B7942F93DE82BF2FEF4C8E 0 >> ~/.gnupg/sshcontrol
```

### ç™»éŒ²ã—ãŸéµã®ç¢ºèª

ç™»éŒ²ã—ãŸéµã¯ `ssh-add -l` ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã‚‹ã€‚å…¬é–‹éµã®å–ã‚Šå‡ºã—ã¯ `ssh-add -L` ã‚³ãƒãƒ³ãƒ‰ã§ã„ã„ã‹ãªã€‚ [GnuPG] ã§ä½œæˆã—ãŸéµãªã‚‰

```
$ gpg --export-ssh-key alice
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFfjejx/Saej929myfZoBQAKgusPi2iiOxdZZfpCLxh5 openpgp:0x390C3E49
```

ã§ã‚‚å–ã‚Šå‡ºã›ã‚‹ã€‚

## å‚è€ƒãƒšãƒ¼ã‚¸

https://curiouslynerdy.com/gpg-agent-for-ssh-on-ubuntu/

https://text.baldanders.info/remark/2020/06/upgrade-openssh-key/

https://text.baldanders.info/openpgp/build-gnupg-in-ubuntu/

[GnuPG]: https://gnupg.org/ "The GNU Privacy Guard"
[OpenSSH]: http://www.openssh.com/ "OpenSSH"
[OpenPGP]: http://openpgp.org/

## å‚è€ƒå›³æ›¸

https://www.amazon.co.jp/dp/B015643CPE
<!-- eof -->
